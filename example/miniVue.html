<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MiniVue é€‰é¡¹å¼ API å®ç°</title>
  </head>
  <body>
    <div id="app">
      <p>å½“å‰è®¡æ•°ï¼š{{ count }}</p>
      <p>åŒå€è®¡æ•°ï¼š{{ doubleCount }}</p>
      <button @click="increment">å¢åŠ </button>
      <button @click="decrement">å‡å°‘</button>
    </div>

    <script>
      // MiniVue æ ¸å¿ƒç±»
      class MiniVue {
        constructor(options) {
          // console.log(options);

          this.$options = options; // å­˜å‚¨ Vue é€‰é¡¹
          this.$data = options.data ? options.data() : {}; // è°ƒç”¨ data() è·å–æ•°æ®
          this.$methods = options.methods || {}; // å­˜å‚¨ methods æ–¹æ³•
          this.$computed = options.computed || {}; // å­˜å‚¨ computed è®¡ç®—å±æ€§
          this.$el = document.querySelector(options.el); // è·å–æŒ‚è½½çš„ DOM å…ƒç´ 

          // è®© data å˜æˆå“åº”å¼
          this.observe(this.$data);

          // ä»£ç† data åˆ° Vue å®ä¾‹ä¸Šï¼Œæ”¯æŒ `this.count` ç›´æ¥è®¿é—® `this.$data.count`
          Object.keys(this.$data).forEach((key) => {
            Object.defineProperty(this, key, {
              get: () => this.$data[key], // ä»£ç† getter
              set: (val) => (this.$data[key] = val), // ä»£ç† setter
            });
          });

          // åˆå§‹åŒ–è®¡ç®—å±æ€§ computed
          this.initComputed();

          // ç»‘å®š methods åˆ° Vue å®ä¾‹ï¼Œä½¿ `this.increment()` å¯ç”¨
          Object.keys(this.$methods).forEach((method) => {
            this[method] = this.$methods[method].bind(this);
          });

          // è§£ææ¨¡æ¿å¹¶æ¸²æŸ“
          this.compile(this.$el);
        }

        // ä½¿ data å“åº”å¼
        observe(obj) {
          console.log(obj);
          Object.keys(obj).forEach((key) => {
            let value = obj[key]; // è·å–å±æ€§å€¼
            const dep = new Dep(); // ä¾èµ–ç®¡ç†å™¨

            Object.defineProperty(obj, key, {
              get() {
                if (Dep.target) dep.addDep(Dep.target); // æ”¶é›†ä¾èµ–
                return value;
              },
              set(newVal) {
                if (value !== newVal) {
                  value = newVal;
                  dep.notify(); // æ•°æ®å˜æ›´æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰ä¾èµ–æ›´æ–°
                }
              },
            });
          });
        }

        // åˆå§‹åŒ– computed è®¡ç®—å±æ€§
        initComputed() {
          Object.keys(this.$computed).forEach((key) => {
            Object.defineProperty(this, key, {
              get: () => this.$computed[key].call(this), // è®¡ç®—å±æ€§æ‰§è¡Œæ—¶ï¼Œè‡ªåŠ¨è·å– this ä¸Šçš„æ•°æ®
            });
          });
        }

        // è§£ææ¨¡æ¿ï¼ˆæŸ¥æ‰¾ {{}} å¹¶æ›¿æ¢æ•°æ®ï¼ŒåŒæ—¶ç›‘å¬å˜åŒ–ï¼‰
        compile(el) {
          const nodes = el.childNodes; // è·å–æ‰€æœ‰å­èŠ‚ç‚¹

          nodes.forEach((node) => {
            if (node.nodeType === 3) {
              // æ–‡æœ¬èŠ‚ç‚¹
              const text = node.nodeValue;
              const reg = /\{\{(.*?)\}\}/g; // åŒ¹é… {{ count }}
              if (reg.test(text)) {
                this.updateText(node, text); // æ›´æ–°æ–‡æœ¬
              }
            }

            if (node.nodeType === 1) {
              // å…ƒç´ èŠ‚ç‚¹ï¼ˆè§£æäº‹ä»¶ï¼‰
              const attrs = node.attributes;
              Array.from(attrs).forEach((attr) => {
                if (attr.name.startsWith("@")) {
                  // è§£æ @click äº‹ä»¶
                  const eventType = attr.name.slice(1); // å–å‡ºäº‹ä»¶ç±»å‹ "click"
                  const methodName = attr.value; // å–å‡ºæ–¹æ³•å "increment"
                  node.addEventListener(eventType, this[methodName].bind(this)); // ç»‘å®šäº‹ä»¶
                }
              });
            }

            if (node.childNodes.length) {
              // é€’å½’ç¼–è¯‘å­èŠ‚ç‚¹
              this.compile(node);
            }
          });
        }

        // æ›´æ–°æ–‡æœ¬èŠ‚ç‚¹
        updateText(node, text) {
          text.replace(/\{\{(.*?)\}\}/g, (_, exp) => {
            exp = exp.trim(); // å»æ‰é¦–å°¾ç©ºæ ¼ï¼Œè·å–å˜é‡å
            node.nodeValue = text.replace(/\{\{(.*?)\}\}/g, this[exp]); // åˆæ¬¡å¡«å……æ•°æ®
            new Watcher(this, exp, (newVal) => {
              node.nodeValue = text.replace(/\{\{(.*?)\}\}/g, newVal); // æ•°æ®å˜åŒ–æ—¶ï¼Œæ›´æ–° UI
            });
          });
        }
      }

      // ä¾èµ–ç®¡ç†å™¨ï¼ˆDepï¼‰ï¼Œç”¨äºæ”¶é›† Watcher
      class Dep {
        constructor() {
          this.subs = []; // å­˜å‚¨ä¾èµ–
        }

        addDep(watcher) {
          this.subs.push(watcher); // æ·»åŠ ä¾èµ–
        }

        notify() {
          this.subs.forEach((watcher) => watcher.update()); // æ•°æ®å˜åŒ–æ—¶ï¼Œè§¦å‘ Watcher æ›´æ–° UI
        }
      }

      // è§‚å¯Ÿè€…ï¼ˆWatcherï¼‰ï¼Œå½“æ•°æ®æ›´æ–°æ—¶ï¼Œæ‰§è¡Œå›è°ƒ
      class Watcher {
        constructor(vm, key, callback) {
          this.vm = vm;
          this.key = key;
          this.callback = callback;

          Dep.target = this; // è®© Dep çŸ¥é“å½“å‰ Watcher
          this.value = vm[key]; // è§¦å‘ getter è¿›è¡Œä¾èµ–æ”¶é›†
          Dep.target = null; // ä¾èµ–æ”¶é›†å®Œæˆåï¼Œæ¸…ç©º
        }

        update() {
          const newVal = this.vm[this.key]; // è·å–æœ€æ–°çš„å€¼
          if (this.value !== newVal) {
            // åªæœ‰å€¼å˜åŒ–æ—¶æ‰æ›´æ–°
            this.value = newVal;
            this.callback(newVal); // æ‰§è¡Œå›è°ƒï¼Œæ›´æ–° UI
          }
        }
      }

      // åˆ›å»º MiniVue å®ä¾‹
      const app = new MiniVue({
        el: "#app", // ç»‘å®šåˆ° #app
        data() {
          return { count: 0 }; // data æ•°æ®
        },
        computed: {
          doubleCount() {
            return this.count * 2; // è®¡ç®—å±æ€§
          },
        },
        methods: {
          increment() {
            this.count++; // å¢åŠ  count
          },
          decrement() {
            this.count--; // å‡å°‘ count
          },
        },
      });
    </script>
  </body>
</html>

<!-- ğŸŒŸ ä»£ç è§£æ
1. Vue é€‰é¡¹å¼ API å®ç°
âœ… data() â†’ this.$dataï¼ˆå“åº”å¼ï¼‰
âœ… computed â†’ è®¡ç®—å±æ€§ï¼Œè‡ªåŠ¨æ›´æ–°
âœ… methods â†’ ç»‘å®šåˆ° this ä¸Šï¼Œæ”¯æŒ @click äº‹ä»¶
âœ… el â†’ æŸ¥æ‰¾ DOM å¹¶è§£æ {{ count }}

2. æ•°æ®å“åº”å¼
observe() æ‹¦æˆª data çš„ get å’Œ set
Dep è´Ÿè´£ç®¡ç†ä¾èµ–
Watcher ç›‘å¬æ•°æ®å˜åŒ–ï¼Œæ›´æ–° UI
3. æ¨¡æ¿è§£æ
åŒ¹é… {{ count }} å¹¶æ›¿æ¢æˆ this.count çš„å€¼
è‡ªåŠ¨ç›‘å¬æ•°æ®å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°
4. äº‹ä»¶ç»‘å®š
@click="increment" è§£æä¸º this.increment() -->
